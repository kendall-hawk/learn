<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learner</title>
    
    <!-- PWA设置 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Learner">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    
    <!-- 预加载关键资源 -->
    <link rel="preload" href="css/style.css" as="style">
    <link rel="preload" href="js/core.js" as="script">
    <link rel="preload" href="data/navigation.json" as="fetch" crossorigin>
    
    <!-- 字体预加载 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Antic+Slab&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700&family=EB+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=emoji_objects" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=emoji_objects" />
    
    
    <!-- 主样式表 -->
    <link rel="stylesheet" href="css/style.css">

    <!-- 关键CSS内联（防闪烁） -->
    <style>
        /* 基础布局防闪烁 */
        body { opacity: 0; transition: opacity 0.3s ease; }
        body.loaded { opacity: 1; }
        
        /* 加载指示器 */
        .loading-indicator {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: #ffffff; z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            flex-direction: column; gap: 1rem;
        }
        
        .loading-spinner {
            width: 32px; height: 32px;
            border: 3px solid #f3f3f3; border-top: 3px solid #007bff;
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 错误处理 */
        .error-boundary {
            text-align: center; padding: 2rem; color: #dc3545;
            background: #f8f9fa; border-radius: 0.5rem; margin: 1rem;
        }
        
        /* 确保下拉菜单不被截断 */
        .site-header {
            overflow: visible !important;
        }
        
        .main-navigation {
            overflow: visible !important;
        }
    </style>
    <!-- 3. JavaScript智能滚动控制 - 添加到页面底部 -->

</head>

<body>
    <!-- 加载指示器 -->
    <div id="loading-indicator" class="loading-indicator">
        <div class="loading-spinner" aria-label="加载中"></div>
        <div class="loading-text">正在加载应用...</div>
    </div>
    
<header class="site-header smart-header" role="banner">
    <!-- 品牌头部 - 始终显示 -->
    <div class="brand-header">
        <div class="brand-container">
            <h1 class="brand-title">
                <span class="brand-text">learner
                </span>
                <span class="brand-en">En
                    </span>
            </h1>
        </div>
    </div>
    <button onclick="useStandaloneMode()" style="position: fixed; top: 160px; right: 10px; z-index: 9999; background: #28a745; color: white; border: none; padding: 10px; border-radius: 5px;">
    🚀 独立模式
</button>
        <!-- 临时添加到页面顶部 -->
    <button onclick="diagnoseWordFreq()" style="position: fixed; top: 110px; right: 10px; z-index: 9999; background: #ffc107; color: black; border: none; padding: 10px; border-radius: 5px;">
    🔍 诊断词频
</button>
<button onclick="checkScripts()" style="position: fixed; top: 210px; right: 10px; z-index: 9999; background: #dc3545; color: white; border: none; padding: 10px; border-radius: 5px;">
    📋 检查脚本
</button>
<button onclick="checkWordFreqClasses()" style="position: fixed; top: 260px; right: 10px; z-index: 9999; background: #17a2b8; color: white; border: none; padding: 10px; border-radius: 5px;">
    🔍 检查类
</button>
<button onclick="fixWordFreqClasses()" style="position: fixed; top: 310px; right: 10px; z-index: 9999; background: #e83e8c; color: white; border: none; padding: 10px; border-radius: 5px;">
    🔧 修复类
</button>
<button onclick="retryStandalone()" style="position: fixed; top: 360px; right: 10px; z-index: 9999; background: #6f42c1; color: white; border: none; padding: 10px; border-radius: 5px;">
    🔄 重试独立
</button>
<button onclick="checkScriptErrors()" style="position: fixed; top: 410px; right: 10px; z-index: 9999; background: #fd7e14; color: white; border: none; padding: 10px; border-radius: 5px;">
    🚨 检查错误
</button>
<button onclick="createMinimalWordFreq()" style="position: fixed; top: 460px; right: 10px; z-index: 9999; background: #20c997; color: white; border: none; padding: 10px; border-radius: 5px;">
    🛠️ 最小版本
</button>
    <!-- 导航栏 - 智能隐藏/显示 -->
    <nav id="main-nav" class="main-navigation smart-nav" role="navigation" aria-label="主导航">
        <!-- 导航内容将由JavaScript动态生成 -->
    </nav>
</header>

    <!-- 主要内容区域 -->
    <main id="content" class="content-area" role="main">
        <!-- 内容将由JavaScript动态加载 -->
        <div style="text-align: center; padding: 40px;">
            <h1>欢迎使用 Learner</h1>
            <p>正在加载导航和内容...</p>
        </div>
    </main>
    
    
    <!-- 返回顶部按钮 -->
    <button id="back-to-top" class="back-to-top" aria-label="返回顶部" title="返回顶部">
        <span aria-hidden="true">↑</span>
    </button>
    
    <!-- 章节导航 -->
    <div id="chapter-nav-container" role="navigation" aria-label="章节导航">
        <!-- 章节导航按钮将由JavaScript动态生成 -->
    </div>
    
    <!-- 音频播放器 -->
    <div id="player-section" style="display: none;" role="contentinfo">
        <audio id="audio-player" controls preload="none" aria-label="章节音频">
            <p>您的浏览器不支持音频播放功能。</p>
        </audio>
    </div>
    
    <!-- 词汇表弹窗 -->
    <div id="glossary-popup" class="glossary-popup glossary-hidden" role="dialog" aria-modal="true" aria-labelledby="glossary-word">
        <div class="glossary-header">
            <h3 id="glossary-word" tabindex="-1"></h3>
            <div class="glossary-part-of-speech" aria-label="词性"></div>
        </div>
        <div class="glossary-popup-content">
            <div class="glossary-main-definition-container" aria-label="主要定义"></div>
            <div class="glossary-contextual-meaning-container" aria-label="语境含义"></div>
            <div class="glossary-example-container" aria-label="例句"></div>
            <dl class="glossary-details-list" aria-label="详细信息"></dl>
        </div>
    </div>



    <!-- 在其他JS文件之前加载 -->
    <script src="js/core.js" defer></script>
    <!-- JavaScript模块加载 -->
    <script>
function createMinimalWordFreq() {
    try {
        alert('🛠️ 创建最小词频管理器...');
        
        // 创建最小词频管理器
        class MinimalWordFreqManager {
            constructor() {
                this.isInitialized = false;
                this.initPromise = this.initialize();
            }
            
            async initialize() {
                // 模拟初始化
                await new Promise(resolve => setTimeout(resolve, 1000));
                this.isInitialized = true;
                return true;
            }
            
            async waitForReady() {
                return this.initPromise;
            }
            
            getTopWords(limit = 100) {
                // 返回示例数据
                return [
                    { word: 'example', totalCount: 10, articleCount: 3 },
                    { word: 'test', totalCount: 8, articleCount: 2 },
                    { word: 'demo', totalCount: 6, articleCount: 2 }
                ];
            }
            
            searchWords(query) {
                return [
                    { word: query, totalCount: 5, articleCount: 1, isIntelligentMatch: true }
                ];
            }
            
            searchWordsExact(query) {
                return [
                    { word: query, totalCount: 3, articleCount: 1, isExactMatch: true }
                ];
            }
            
            getWordDetails(word) {
                return {
                    word: word,
                    totalCount: 5,
                    articleCount: 2,
                    articles: [
                        { id: 'demo1', title: '示例文章1', count: 3 },
                        { id: 'demo2', title: '示例文章2', count: 2 }
                    ]
                };
            }
            
            getStatsSummary() {
                return {
                    totalUniqueWords: 1000,
                    totalWordOccurrences: 5000,
                    totalArticlesAnalyzed: 50,
                    averageWordsPerArticle: 100
                };
            }
            
            getArticleDifficulty(articleId) {
                return {
                    stars: 3,
                    label: "⭐⭐⭐ 中等",
                    tooltip: "演示难度"
                };
            }
            
            destroy() {
                this.isInitialized = false;
            }
        }
        
        // 注册到EnglishSite
        window.EnglishSite.WordFrequencyManager = MinimalWordFreqManager;
        
        alert('✅ 最小词频管理器创建成功！');
        
        // 立即测试
        testMinimalVersion();
        
    } catch (error) {
        alert('❌ 创建失败: ' + error.message);
    }
}

function testMinimalVersion() {
    try {
        alert('🧪 测试最小版本...');
        
        const container = document.querySelector('#content');
        if (!container) {
            alert('❌ 找不到容器');
            return;
        }
        
        // 检查UI类
        if (!window.EnglishSite.WordFrequencyUI) {
            alert('❌ UI类不存在');
            return;
        }
        
        // 清空容器
        container.innerHTML = '<div style="text-align: center; padding: 50px; background: #e8f5e8;"><h2>🔤 最小版词频工具</h2><p>正在启动演示版本...</p></div>';
        
        // 创建实例
        const manager = new window.EnglishSite.WordFrequencyManager();
        const ui = new window.EnglishSite.WordFrequencyUI(container, manager);
        
        alert('✅ 实例创建成功，开始初始化...');
        
        // 初始化
        manager.waitForReady()
            .then(() => {
                alert('✅ 管理器就绪，初始化UI...');
                return ui.initialize();
            })
            .then(() => {
                alert('🎉 最小版词频工具启动成功！这是演示版本，包含示例数据。');
                
                // 保存到全局
                window.wordFreqManager = manager;
                window.wordFreqUI = ui;
            })
            .catch(error => {
                alert('❌ 初始化失败: ' + error.message);
                container.innerHTML = `
                    <div style="padding: 20px; color: red; text-align: center;">
                        <h3>初始化失败</h3>
                        <p>${error.message}</p>
                        <button onclick="location.reload()">重新加载页面</button>
                    </div>
                `;
            });
            
    } catch (error) {
        alert('❌ 测试失败: ' + error.message);
    }
}
</script>
    <script>
function checkScriptErrors() {
    alert('🚨 检查脚本执行状态...');
    
    // 检查词频脚本是否完全执行
    const checks = [
        'SimplifiedWordStemmer',
        'SimplifiedWordFrequencyAnalyzer', 
        'SimplifiedWordFrequencyManager',
        'CompatibilityLayer'
    ];
    
    let result = '脚本执行检查:\n';
    checks.forEach(className => {
        const exists = typeof window[className] !== 'undefined';
        result += `• ${className}: ${exists ? '✅' : '❌'}\n`;
    });
    
    alert(result);
    
    // 检查是否有部分类在其他地方
    const globalVars = Object.getOwnPropertyNames(window).filter(name => 
        name.includes('Word') || name.includes('Freq') || name.includes('Stemmer')
    );
    
    alert(`全局词频相关变量:\n${globalVars.join('\n') || '无'}`);
}
</script>
    <script>
function retryStandalone() {
    alert('🔄 重新尝试独立模式...');
    
    // 确保类存在
    if (!window.EnglishSite?.WordFrequencyManager) {
        alert('❌ 管理器类仍然不存在，请先运行"修复类"');
        return;
    }
    
    if (!window.EnglishSite?.WordFrequencyUI) {
        alert('❌ UI类不存在');
        return;
    }
    
    try {
        const container = document.querySelector('#content');
        container.innerHTML = '<div style="text-align: center; padding: 50px; background: #f0f8ff;"><h2>🔤 词频分析工具</h2><p>正在启动修复版...</p></div>';
        
        // 创建实例
        const manager = new window.EnglishSite.WordFrequencyManager();
        const ui = new window.EnglishSite.WordFrequencyUI(container, manager);
        
        alert('✅ 实例创建成功，等待初始化...');
        
        // 等待初始化
        manager.waitForReady()
            .then(() => {
                alert('✅ 管理器就绪，初始化UI...');
                return ui.initialize();
            })
            .then(() => {
                alert('🎉 词频工具启动成功！');
                // 保存到全局以便调试
                window.wordFreqManager = manager;
                window.wordFreqUI = ui;
            })
            .catch(error => {
                alert('❌ 初始化失败: ' + error.message);
                container.innerHTML = `<div style="padding: 20px; color: red;">初始化失败: ${error.message}</div>`;
            });
            
    } catch (error) {
        alert('❌ 创建实例失败: ' + error.message);
    }
}
</script>
  
    <script>
function fixWordFreqClasses() {
    try {
        alert('🔧 尝试手动修复类注册...');
        
        // 检查是否有全局类可用
        if (typeof window.SimplifiedWordFrequencyManager !== 'undefined') {
            alert('✅ 找到全局SimplifiedWordFrequencyManager，开始修复...');
            
            // 手动注册到 EnglishSite
            window.EnglishSite = window.EnglishSite || {};
            window.EnglishSite.WordFrequencyManager = window.SimplifiedWordFrequencyManager;
            
            alert('✅ 已手动注册WordFrequencyManager类');
        } else if (typeof window.WordFrequencyManager !== 'undefined') {
            alert('✅ 找到全局WordFrequencyManager');
            window.EnglishSite.WordFrequencyManager = window.WordFrequencyManager;
        } else {
            alert('❌ 找不到任何词频管理器类');
            return;
        }
        
        // 检查其他必要的类
        const requiredClasses = [
            'SimplifiedWordFrequencyAnalyzer',
            'SimplifiedWordStemmer', 
            'WordFrequencyUI',
            'SimplifiedSearchManager'
        ];
        
        requiredClasses.forEach(className => {
            if (window[className] && !window.EnglishSite[className]) {
                window.EnglishSite[className] = window[className];
                alert(`✅ 已注册 ${className}`);
            }
        });
        
        // 验证修复结果
        const hasManager = !!window.EnglishSite.WordFrequencyManager;
        const hasUI = !!window.EnglishSite.WordFrequencyUI;
        
        alert(`修复结果:\n• WordFrequencyManager: ${hasManager ? '✅' : '❌'}\n• WordFrequencyUI: ${hasUI ? '✅' : '❌'}`);
        
        if (hasManager && hasUI) {
            alert('🎉 类修复成功！现在可以尝试独立模式了');
        }
        
    } catch (error) {
        alert('❌ 修复失败: ' + error.message);
    }
}
</script>
 <script>
function checkWordFreqClasses() {
    alert('🔍 检查词频相关类...');
    
    // 检查 EnglishSite 对象的内容
    const englishSite = window.EnglishSite || {};
    const keys = Object.keys(englishSite);
    
    alert(`EnglishSite 包含的类:\n${keys.join('\n')}`);
    
    // 检查具体的词频相关类
    const checks = {
        'WordFrequencyManager': !!englishSite.WordFrequencyManager,
        'SimplifiedWordFrequencyManager': !!window.SimplifiedWordFrequencyManager,
        'WordFrequencyUI': !!englishSite.WordFrequencyUI,
        'SimplifiedWordFrequencyAnalyzer': !!englishSite.SimplifiedWordFrequencyAnalyzer,
        'SimplifiedWordStemmer': !!englishSite.SimplifiedWordStemmer
    };
    
    let result = '类检查结果:\n';
    for (const [name, exists] of Object.entries(checks)) {
        result += `• ${name}: ${exists ? '✅' : '❌'}\n`;
    }
    
    alert(result);
    
    // 检查是否有全局的词频类（可能没有正确导出）
    const globalChecks = {
        'window.SimplifiedWordFrequencyManager': typeof window.SimplifiedWordFrequencyManager,
        'window.WordFrequencyUI': typeof window.WordFrequencyUI,
        'window.SimplifiedWordFrequencyAnalyzer': typeof window.SimplifiedWordFrequencyAnalyzer
    };
    
    let globalResult = '全局类检查:\n';
    for (const [name, type] of Object.entries(globalChecks)) {
        globalResult += `• ${name}: ${type}\n`;
    }
    
    alert(globalResult);
}
</script>
    <script>
function checkScripts() {
    const scripts = document.querySelectorAll('script[src]');
    let wordFreqScript = null;
    let mainScript = null;
    
    scripts.forEach(script => {
        if (script.src.includes('word-frequency')) {
            wordFreqScript = script.src;
        }
        if (script.src.includes('main.js')) {
            mainScript = script.src;
        }
    });
    
    alert(`脚本检查:\n• 总脚本数: ${scripts.length}\n• 词频脚本: ${wordFreqScript ? '✅' : '❌'}\n• 主脚本: ${mainScript ? '✅' : '❌'}\n• EnglishSite: ${!!window.EnglishSite ? '✅' : '❌'}`);
    
    if (wordFreqScript) {
        alert(`词频脚本路径: ${wordFreqScript}`);
    }
}
</script>
    <script>
function useStandaloneMode() {
    try {
        alert('🚀 尝试独立模式启动...');
        
        // 清空当前内容
        const container = document.querySelector('#content') || 
                         document.querySelector('main') || 
                         document.body;
        
        if (!container) {
            alert('❌ 找不到容器');
            return;
        }
        
        // 检查类是否存在
        if (!window.EnglishSite?.WordFrequencyManager) {
            alert('❌ 词频管理器类不存在');
            return;
        }
        
        if (!window.EnglishSite?.WordFrequencyUI) {
            alert('❌ 词频UI类不存在');
            return;
        }
        
        alert('✅ 类检查通过，开始创建实例...');
        
        // 清空容器
        container.innerHTML = '<div style="text-align: center; padding: 50px;"><h2>🔤 词频分析工具</h2><p>正在启动独立模式...</p></div>';
        
        // 创建独立的词频管理器
        const manager = new window.EnglishSite.WordFrequencyManager();
        const ui = new window.EnglishSite.WordFrequencyUI(container, manager);
        
        // 等待初始化
        manager.waitForReady().then(() => {
            alert('✅ 管理器准备就绪，初始化UI...');
            return ui.initialize();
        }).then(() => {
            alert('🎉 独立模式启动成功！');
        }).catch(error => {
            alert('❌ 独立模式失败: ' + error.message);
        });
        
    } catch (error) {
        alert('❌ 独立模式异常: ' + error.message);
    }
}
</script>
<script>
function diagnoseWordFreq() {
    let step = 1;
    
    try {
        alert(`步骤${step++}: 检查App实例...`);
        if (!window.app) {
            alert('❌ App实例不存在');
            return;
        }
        
        alert(`步骤${step++}: 检查容器...`);
        const content = document.querySelector('#content');
        const main = document.querySelector('main');
        const container = content || main || document.body;
        if (!container) {
            alert('❌ 找不到容器');
            return;
        }
        alert(`✅ 找到容器: ${container.tagName}#${container.id}`);
        
        alert(`步骤${step++}: 检查词频管理器状态...`);
        const hasManager = !!window.app.wordFreqManager;
        const isInitialized = window.app.state?.wordFreqInitialized;
        const hasPromise = !!window.app.wordFreqManagerPromise;
        alert(`管理器存在: ${hasManager}\n已初始化: ${isInitialized}\n有Promise: ${hasPromise}`);
        
        alert(`步骤${step++}: 检查词频类...`);
        const hasManagerClass = !!window.EnglishSite?.WordFrequencyManager;
        const hasUIClass = !!window.EnglishSite?.WordFrequencyUI;
        alert(`管理器类: ${hasManagerClass}\nUI类: ${hasUIClass}`);
        
        alert(`步骤${step++}: 检查全局函数...`);
        const hasGlobalFunc = typeof window.navigateToWordFrequency === 'function';
        alert(`全局函数: ${hasGlobalFunc}`);
        
        if (hasGlobalFunc) {
            alert(`步骤${step++}: 尝试直接调用全局函数...`);
            try {
                const result = window.navigateToWordFrequency();
                alert(`直接调用结果: ${result}`);
            } catch (err) {
                alert(`直接调用失败: ${err.message}`);
            }
        }
        
    } catch (error) {
        alert(`诊断在步骤${step}失败: ${error.message}`);
    }
}
</script>
    <script>
        // 基础错误处理和超时检测
        window.addEventListener('error', function(e) {
            console.error('应用错误:', e.error);
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.innerHTML = `
                    <div class="error-boundary">
                        <h2>🚫 加载失败</h2>
                        <p>应用启动时遇到问题，请刷新页面重试。</p>
                        <button onclick="location.reload()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            🔄 重新加载
                        </button>
                    </div>
                `;
            }
        });
        
        // 超时检测（15秒）
        setTimeout(function() {
            if (!window.EnglishSite || !document.body.classList.contains('loaded')) {
                const indicator = document.getElementById('loading-indicator');
                if (indicator && indicator.style.display !== 'none') {
                    indicator.innerHTML = `
                        <div class="error-boundary">
                            <h3>⏱️ 加载超时</h3>
                            <p>网络连接可能存在问题，请检查后重试。</p>
                            <button onclick="location.reload()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">重新加载</button>
                        </div>
                    `;
                }
            }
        }, 15000);
        
        // 应用启动完成处理
        document.addEventListener('DOMContentLoaded', function() {
            function hideLoading() {
                const indicator = document.getElementById('loading-indicator');
                if (indicator) {
                    indicator.style.opacity = '0';
                    setTimeout(() => {
                        indicator.style.display = 'none';
                        document.body.classList.add('loaded');
                    }, 300);
                }
            }
            
            // 等待应用初始化完成
            if (window.EnglishSite && window.EnglishSite.coreToolsReady) {
                window.EnglishSite.coreToolsReady.then(() => {
                    // 额外等待确保导航渲染完成
                    setTimeout(hideLoading, 800);
                }).catch(() => {
                    hideLoading();
                });
            } else {
                // 降级处理
                setTimeout(hideLoading, 2000);
            }
        });
        
// 按Ctrl+
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.shiftKey && e.key === 'D') {
        if (!document.getElementById('debug-panel')) {
            loadDebugTool();
        }
    }
});

function loadDebugTool() {
    // 在这里插入调试工具的CSS和JavaScript代码
    // ... (从上面的HTML中复制 <style> 和 <script> 部分)
}
    </script>
    
    <!-- 核心基础设施（必须最先加载） -->
    
    <!-- 功能模块（按依赖顺序加载） -->
    <script src="js/navigation.js" defer></script>
    <script src="js/audio-sync.js" defer></script>
    <script src="js/glossary.js" defer></script>
    
    <!-- 词频工具模块 -->
    <script src="js/word-frequency.js" defer></script>
    <script src="js/word-frequency-ui.js" defer></script>
    <script src="js/word-frequency-global.js"></script>
    <script src="js/word-highlight.js" defer></script>
    
    <!-- 主应用（最后加载） -->
    <script src="js/main.js" defer></script>
</body>
</html>